<tool id="confil" name="Contamination Filter (confil)" version="0.1.3">
    <requirements>
        <requirement type="package" version="7.0">click</requirement>
        <requirement type="package" version="2.0.7_beta">kraken2</requirement>
        <requirement type="package" version="dev20190305">confil</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        #set $input_type = $input_type_conditional.input_type
        #import re

        ####### Single Input
        #if $input_type == "single"
        ln -s "${input_type_conditional.single_input}" $input_type_conditional.single_input.element_identifier &&
        #set report_name = os.path.splitext(os.path.basename($input_type_conditional.single_input.element_identifier))[0]
        #set report_name = re.sub('_[0-9]+$', '', str(report_name)) + '.tab'

        confil --threads $threads --cutoff $cutoff 
        $input_type_conditional.single_input.element_identifier
        && mv $report_name '$output_report'
        && ln -sf "${input_type_conditional.single_input}" '$single_output_file'

        ####### Paired Collection
        #elif $input_type == "paired_collection"
        ln -s "${input_type_conditional.collection_input.forward}" $input_type_conditional.collection_input.forward.element_identifier &&
        ln -s "${input_type_conditional.collection_input.reverse}" $input_type_conditional.collection_input.reverse.element_identifier &&
        #set report_name = os.path.splitext(os.path.basename($input_type_conditional.collection_input.forward.element_identifier))[0]
        #set report_name = re.sub('_[0-9]+$', '', str(report_name)) + '.tab'

        confil --threads $threads --cutoff $cutoff --paired 
        $input_type_conditional.collection_input.forward.element_identifier $input_type_conditional.collection_input.reverse.element_identifier
        && mv $report_name '$output_report'
        && ln -sf "${input_type_conditional.collection_input.forward}" '$list_output.forward'
        && ln -sf "${input_type_conditional.collection_input.reverse}" '$list_output.reverse'
        #end if
    ]]>
    </command>
    <inputs>
        <conditional name="input_type_conditional">
            <param name="input_type" type="select" label="Select Input Type">
                <option value="single" selected="true">Single Dataset</option>
                <option value="paired_collection">Paired Collection</option>
            </param>
            <when value="single">
                <param name="single_input" type="data" format="fq,fastq,fastq.gz,fastqsanger" label="Select FASTQ Dataset" help="Specify dataset with single reads" />
            </when>
            <when value="paired_collection">
                <param name="collection_input" format="fq,fastq,fastq.gz,fastqsanger" type="data_collection" collection_type="paired" label="Select Dataset Pair" help="Specify paired dataset collection containing paired reads" />
            </when>
        </conditional>
        <param name="cutoff" type="integer" label="Cutoff percentage" value="50" min="50" max="99" />
        <param name="threads" type="integer" label="Number of threads" value="1" min="1" max="4" />
    </inputs>
    <outputs>
        <data name="output_report" format="tabular" label="Kraken2 report" />
        <data name="single_output_file" format="fastq" label="${tool.name} single output">
            <filter>input_type_conditional['input_type'] == "single"</filter>
        </data>
        <collection name="list_output" type="paired" label="${tool.name} paired output" structured_like="collection_input" inherit_format="true">
            <filter>input_type_conditional['input_type'] == "paired_collection"</filter>
            <data name="forward" format="fastq" />
            <data name="reverse" format="fastq" />
        </collection>
    </outputs>
    <tests>
        <test>
            <param name="single_input" value="seq_1.fastq" />
            <param name="input_type" value="single" />
            <output name="output_report" ftype="tabular" file="seq.tab" />
            <output name="single_output_file" ftype="fastq" file="seq_1.fastq" />
        </test>
        <test>
            <param name="collection_input">
                <collection type="paired">
                    <element name="forward" value="seq_1.fastq" />
                    <element name="reverse" value="seq_2.fastq" />
                </collection>
            </param>
            <param name="input_type" value="paired_collection" />
            <output name="output_report" ftype='tabular' file="seq.tab" />
            <output_collection name="list_output" type="paired">
                <element name="forward" value="seq_1.fastq">
                </element>
                <element name="reverse" value="seq_2.fastq">
                </element>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
        confil parses a kraken2 report and determines contamination based on a specified cutoff.
    ]]>    </help>
    <citations>
        <citation type="bibtex">
@misc{githubconfil,
  author = {SANBI-SA},
  year = {2019},
  title = {confil},
  publisher = {GitHub},
  journal = {GitHub repository},
  url = {https://github.com/COMBAT-TB/confil},
}</citation>
    </citations>
</tool>
